<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>バレースコア記録</title>
<style>
  html,body{height:100%;margin:0;padding:0;}
  body{font-family:system-ui,-apple-system,"Hiragino Kaku Gothic ProN","メイリオ",Meiryo,sans-serif;
    background: linear-gradient(180deg,#f6f7fb,#ffffff);
    -webkit-text-size-adjust:100%;
  }
  main{max-width:980px;margin:20px auto;background:rgba(255,255,255,0.95);padding:16px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.06);}
  h1{font-size:20px;margin:0 0 12px;}
  h2{font-size:18px;margin:16px 0 8px;}
  .row{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap;}

  /* プレイヤーリストの調整 */
  #players{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:10px 0;}
  @media(max-width:700px){#players{grid-template-columns:repeat(3,1fr);}}
  @media(max-width:500px){#players{grid-template-columns:repeat(2,1fr);}}
  .player{
      background:#fbfdff;
      border:1px solid #e6eefb;
      padding:10px;
      border-radius:8px;
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:stretch;
      position: relative;
  }
  .player h3{margin:0;font-size:16px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
  .player-info{display:flex;justify-content:space-between;align-items:center;}
  .score{font-weight:700;font-size:20px;color:#2a66b9;}
  .sub-btn{
      flex-grow:1;
      padding:8px 6px;
      font-size:14px;
      background:#e5f7e7;
      border-color:#a8e0ae;
      color:#185a1f;
  }

  button{padding:6px 10px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer;transition:background 0.1s;}
  button:active{opacity:0.8;}
  button.action{background:#eef9ff;border-color:#bde0ff;font-weight:500;}

  #actions{margin-top:20px;}
  .action-buttons{display:flex;gap:8px;flex-wrap:wrap;}
  #opponentMiss{background:#e7f7e5;border-color:#b5e8b0;color:#185a1f;}
  #otherPoint{background:#fff9e6;border-color:#ffecb3;color:#6d5813;}
  
  #logSection{margin-top:20px;}
  /* ログタブ */
  .log-tabs { display: flex; border-bottom: 2px solid #eee; margin-bottom: 8px; }
  .log-tab-btn { padding: 8px 15px; cursor: pointer; border: none; background: transparent; font-size: 16px; margin-right: 5px; border-bottom: 2px solid transparent; }
  .log-tab-btn.active { border-bottom: 2px solid #2a66b9; font-weight: bold; color: #2a66b9; background: #f6f7fb; }
  
  #log {
    max-height: 300px;
    overflow-y: auto;
    padding-left: 0;
    background: #f9fafb;
    border-radius: 6px;
    padding: 8px;
    list-style-type: none;
    display: block;
  }
  #log li{padding:6px 8px;border-bottom:1px dashed #eee;font-size:14px;}
  #log li:last-child{border-bottom:none;}
  
  /* モーダル共通 */
  .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:1000;}
  .modal.hidden{display:none;}
  .modal-content{background:#fff;padding:16px;border-radius:12px;min-width:320px;max-width:90%;box-shadow:0 10px 25px rgba(0,0,0,0.1);}
  .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:16px;}
  
  input[type="text"], input[type="number"], select{padding:8px;border-radius:6px;border:1px solid #ddd;font-size:15px;flex-grow:1;}
  label{font-size:14px;}
  .top-right { position: absolute; right: 14px; top: 14px; font-size:12px; opacity:0.8; }

  /* フォーム要素 */
  .modal-form-row { margin-bottom: 12px; }
  .modal-form-row label { display: block; margin-bottom: 4px; font-weight: 500;}

  /* 選択リストの共通調整 */
  .choice-list { 
      display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; 
      max-height: 150px; overflow-y: auto; padding: 4px; border: 1px solid #eee; border-radius: 6px;
  }
  .choice-label input[type="radio"] { display: none;}
  .choice-label {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.2s, border-color 0.2s;
    font-size: 14px;
    font-weight: 500;
    line-height: 1;
  }
  .choice-label:hover { background: #f0f0f0; }
  .choice-label input[type="radio"]:checked + span {
    background: #2196F3;
    color: white;
    border-color: #2196F3;
  }
  .choice-label input[type="radio"]:checked + span:hover {
    background: #1e88e5;
  }
  
  /* 選手登録セクション */
  #allPlayersContainer h3 { font-size: 16px; margin-bottom: 8px; border-bottom: 1px dashed #eee; padding-bottom: 4px;}
  .player-register-row { display: flex; gap: 8px; margin-bottom: 8px; align-items:center;}
  .player-register-row button { flex-shrink: 0; padding: 8px 10px; }
  .player-register-name-input { flex-grow: 1; }

  /* エクスポート画面 */
  #exportModal .modal-content {
      max-width:1200px; 
      min-width:95%; 
      margin:20px;
  }
  #exportInfo {
      background: #eef9ff;
      border: 1px solid #bde0ff;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 15px;
      font-size: 14px;
      line-height: 1.6;
      font-weight: 500;
  }
  #exportInfo p { margin: 4px 0; } 

  #exportScreen {
      background: #f8f8f8;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      overflow-x: auto;
  }
  /* 集計テーブルのスタイル */
  #exportTable {
      min-width: 900px;
      border-collapse: collapse;
      font-size: 13px;
      background: white;
  }
  #exportTable th, #exportTable td {
      border: 1px solid #ddd;
      padding: 8px 6px;
      text-align: center;
      white-space: nowrap;
  }
  #exportTable th {
      background-color: #f2f2f2;
      font-weight: bold;
      color: #333;
      position: sticky;
      top: 0;
  }
  #exportTable th:first-child, #exportTable td:first-child {
      text-align: left;
      min-width: 80px;
      position: sticky;
      left: 0;
      background-color: #f2f2f2;
      z-index: 2;
  }
  #exportTable td:first-child {
      background-color: #fff;
      font-weight: 500;
  }
  .score-col { color: #2a66b9; font-weight: bold; }
  .error-col { color: #d9534f; font-weight: bold; }

</style>
</head>
<body>
  <div class="top-right">オフライン動作可 • Safari推奨</div>
  <main>
    <h1>バレースコア記録</h1>

    <section id="controls">
      <div class="row">
        <label>対戦相手: <input id="opponentName" value="相手" inputmode="text"></label>
        <label>セット数: <input id="currentSet" type="number" min="1" value="1" style="width:50px; text-align:center;"></label>
        <label>リベロ有無:
            <select id="liberoStatus" style="width:auto;">
                <option value="7">リベロあり (7人)</option>
                <option value="6">リベロなし (6人)</option>
            </select>
        </label>
        <button id="newGame">新しい試合</button>
        <button id="showExportScreen">集計・エクスポート</button>
      </div>
    </section>

    <section id="allPlayersContainer">
      <h2>全選手登録・管理</h2>
      <div id="allPlayersList"></div> 
      <div class="player-register-row">
        <input type="text" id="newPlayerName" placeholder="新しい選手名を入力" class="player-register-name-input" inputmode="text" autocomplete="off" />
        <button id="addPlayer">選手を追加</button>
      </div>
    </section>

    <hr style="border:0;border-top:1px solid #eee;margin:20px 0;">

    <h2>コート上のプレイヤー</h2>
    <section id="players"></section>

    <hr style="border:0;border-top:1px solid #eee;margin:20px 0;">

    <section id="actions">
      <h2>アクション記録</h2>
      <div class="action-buttons">
        <button class="action" data-action="サーブ" data-type="POINT_ACTION">サーブ</button>
        <button class="action" data-action="スパイク" data-type="POINT_ACTION">スパイク</button>
        <button class="action" data-action="ブロック" data-type="BLOCK">ブロック</button>
        <button class="action" data-action="レセ" data-type="SERVICE_RECEIVE">レセ</button>
        <button class="action" data-action="チャンス" data-type="DIG_RECEIVE">チャンス</button>
        <button class="action" data-action="ディグ" data-type="DIG_RECEIVE">ディグ</button>
        <button class="action" data-action="二段トス" data-type="SET">二段トス</button>
        <button id="opponentMiss" class="action" data-action="相手ミス">相手ミス</button>
        <button id="otherPoint" class="action" data-action="その他得点">その他得点</button>
      </div>
    </section>

    <section id="logSection">
      <h2>アクションログ</h2>
      <div class="log-tabs">
          <button class="log-tab-btn active" data-tab="all">すべてのアクション</button>
          <button class="log-tab-btn" data-tab="point">得点変動のみ</button>
      </div>
      <div id="logControls" class="row">
        <button id="undo">直前を取り消す</button>
        <button id="clearLog">ログをクリア</button>
      </div>
      <ul id="log"></ul>
    </section>
  </main>

  <div id="modal" class="modal hidden" role="dialog">
    <div class="modal-content">
      <h3 id="modalTitle">アクション記録</h3>
      <form id="actionForm">
        <input type="hidden" name="action" id="modalAction" />
        <input type="hidden" name="type" id="modalType" />

        <div class="modal-form-row">
            <h4>実行プレイヤーを選択してください</h4>
            <div id="player-select-list" class="choice-list"></div>
        </div>

        <div class="modal-form-row">
            <h4>結果を選択してください</h4>
            <div id="result-select-list" class="choice-list"></div>
        </div>
      </form>
      <div class="modal-actions">
        <button id="modalCancel">キャンセル</button>
        <button id="modalConfirm">確定</button>
      </div>
    </div>
  </div>

  <div id="subModal" class="modal hidden" role="dialog">
      <div class="modal-content">
          <h3 id="subModalTitle">プレイヤー交代</h3>
          <form id="subForm">
              <div class="modal-form-row">
                  <div>交代アウトするプレイヤー: <strong id="subOutPlayerName"></strong></div>
                  <div style="margin-top:8px;">交代インするプレイヤーを選択してください:</div>
              </div>
              <div id="sub-player-select-list" class="choice-list"></div>
          </form>
          <div class="modal-actions">
              <button id="subModalCancel">キャンセル</button>
              <button id="subModalConfirm">交代確定</button>
          </div>
      </div>
  </div>

  <div id="exportModal" class="modal hidden" role="dialog">
      <div class="modal-content">
          <h3 id="exportModalTitle">選手別アクション集計結果 (結果別)</h3>
          <div id="exportInfo"></div>
          <div id="exportScreen">
              <table id="exportTable"></table>
          </div>
          <div class="modal-actions">
              <button id="exportModalClose">閉じる</button>
          </div>
      </div>
  </div>

<script>
(function () {
  // --- 定数と状態管理 ---
  let nextPlayerId = 8; 
  let currentSubSlotIndex = null; 

  const state = {
    teamName: '私たち', 
    opponentName: '相手',
    currentSet: 1, 
    matchDate: Date.now(), 
    onCourtSize: 7, 
    allPlayers: [ 
        { id: 1, name: '名前1', totalPoints: 0, totalErrors: 0 },
        { id: 2, name: '名前2', totalPoints: 0, totalErrors: 0 },
        { id: 3, name: '名前3', totalPoints: 0, totalErrors: 0 },
        { id: 4, name: '名前4', totalPoints: 0, totalErrors: 0 },
        { id: 5, name: '名前5', totalPoints: 0, totalErrors: 0 },
        { id: 6, name: '名前6', totalPoints: 0, totalErrors: 0 },
        { id: 7, name: 'リベロ', totalPoints: 0, totalErrors: 0 }
    ],
    onCourtPlayerIds: [1, 2, 3, 4, 5, 6, 7], 
    log: [], 
    teamScore: 0,
    opponentScore: 0 
  };

  // アクションごとの結果の選択肢を定義
  const ACTION_CONFIG = {
    POINT_ACTION: { actions: ['サーブ', 'スパイク'], results: [{ value: '得点', isPoint: true, isError: false, type: 'POINT' }, { value: 'ミス', isPoint: false, isError: true, type: 'ERROR' }, { value: 'その他', isPoint: false, isError: false, type: 'OTHER' }] },
    BLOCK: { actions: ['ブロック'], results: [{ value: 'シャット', isPoint: true, isError: false, type: 'POINT' }, { value: 'ミス', isPoint: false, isError: true, type: 'ERROR' }, { value: 'その他', isPoint: false, isError: false, type: 'OTHER' }] },
    SERVICE_RECEIVE: { actions: ['レセ'], results: [{ value: 'Sオーバー', isPoint: false, isError: false, type: 'SUCCESS' }, { value: 'Sアンダー', isPoint: false, isError: false, type: 'SUCCESS' }, { value: 'ミス', isPoint: false, isError: true, type: 'ERROR' }, { value: 'その他', isPoint: false, isError: false, type: 'OTHER' }] },
    DIG_RECEIVE: { actions: ['チャンス', 'ディグ'], results: [{ value: 'Sオーバー', isPoint: false, isError: false, type: 'SUCCESS' }, { value: 'Sアンダー', isPoint: false, isError: false, type: 'SUCCESS' }, { value: 'ミス', isPoint: false, isError: true, type: 'ERROR' }, { value: 'その他', isPoint: false, isError: false, type: 'OTHER' }] },
    SET: { actions: ['二段トス'], results: [{ value: '打つ', isPoint: false, isError: false, type: 'SUCCESS' }, { value: 'トス', isPoint: false, isError: false, type: 'SUCCESS' }, { value: 'ミス', isPoint: false, isError: true, type: 'ERROR' }, { value: 'その他', isPoint: false, isError: false, type: 'OTHER' }] }
  };
  
  function getActionResults(actionName) {
    for (const typeKey in ACTION_CONFIG) {
        const config = ACTION_CONFIG[typeKey];
        if (config.actions.includes(actionName)) return config.results;
    }
    return ACTION_CONFIG.POINT_ACTION.results;
  }
  
  function getScoreChanges(isPoint, isError, isOpponentPoint, isOpponentMissButton, isOtherPointButton) {
      let teamPointChange = 0;
      let opponentPointChange = 0;

      if (isOpponentMissButton || isOtherPointButton) {
          teamPointChange = 1;
      } else if (isPoint) {
          teamPointChange = 1;
      } else if (isError) {
          opponentPointChange = 1;
      }
      return { teamPointChange, opponentPointChange };
  }

  // --- ヘルパー関数 ---
  const $ = (s) => document.querySelector(s);
  const $$ = (s) => Array.from(document.querySelectorAll(s));
  const STORAGE_KEY = 'v2_offlineScoreApp_improved_v13'; // バージョンキー更新
  
  const save = () => {
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch(e) {}
  };
  
  const load = () => {
    try {
      const v = localStorage.getItem(STORAGE_KEY);
      if (v) {
        const parsed = JSON.parse(v);
        Object.assign(state, parsed);
        
        state.teamScore = state.teamScore || 0;
        state.opponentScore = state.opponentScore || 0; 
        state.allPlayers = state.allPlayers || [];
        state.log = state.log || [];
        state.currentSet = state.currentSet || 1; 
        state.matchDate = state.matchDate || Date.now(); 
        state.onCourtSize = state.onCourtSize || 7;

        const targetSize = state.onCourtSize;
        const currentCourtIds = state.allPlayers.slice(0, targetSize).map(p => p.id);
        while (currentCourtIds.length < targetSize) {
            currentCourtIds.push(0);
        }
        state.onCourtPlayerIds = currentCourtIds.slice(0, targetSize);
        
        if (state.allPlayers.length < targetSize) {
              initPlayers(targetSize, true); 
        }

        const maxId = state.allPlayers.reduce((max, p) => Math.max(max, p.id), 0);
        nextPlayerId = Math.max(maxId + 1, 8); 

        recomputeFromLog(); 
      } else {
        initPlayers(7); 
      }
    } catch(e) { 
      console.error("データロード失敗", e); 
      initPlayers(7);
    }
  };

  // リベロ設定変更時、新規試合時、ロード時に使用
  function initPlayers(n, isLoad = false) {
    const oldPlayers = state.allPlayers;
    const oldCourtIds = state.onCourtPlayerIds;
    
    state.onCourtSize = n;
    state.allPlayers = [];
    state.onCourtPlayerIds = [];

    // 既存のプレイヤーを再利用
    for (let i = 0; i < n; i++) {
        let existingPlayer = oldPlayers.find(p => p.id === oldCourtIds[i]);
        if (existingPlayer) {
            state.allPlayers.push(existingPlayer);
        } else if (i < oldPlayers.length) {
            state.allPlayers.push(oldPlayers[i]);
        } else {
            const name = i === n - 1 && n === 7 ? 'リベロ' : (`名前${i + 1}`);
            const newPlayer = { id: nextPlayerId++, name: name, totalPoints: 0, totalErrors: 0 };
            state.allPlayers.push(newPlayer);
        }
        state.onCourtPlayerIds.push(state.allPlayers[i].id);
    }
    
    // 交代要員だったプレイヤーを追加
    oldPlayers.forEach(p => {
        if (!state.onCourtPlayerIds.includes(p.id)) {
            state.allPlayers.push(p);
        }
    });

    if (!isLoad) {
        state.log = [];
        state.teamScore = 0;
        state.opponentScore = 0;
        state.currentSet = 1;
        state.matchDate = Date.now();
    }
  }

  function getPlayerById(id) {
      return state.allPlayers.find(x => x.id === id);
  }
  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));
  }

  function getFormattedDate(timestamp) {
      const date = new Date(timestamp);
      const year = String(date.getFullYear()).slice(-2);
      const month = date.getMonth() + 1;
      const day = date.getDate();
      const dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'][date.getDay()];
      return `${year}/${month}/${day} (${dayOfWeek})`;
  }

  // --- モーダル/交代処理 ---

  function handleActionButton(e) {
      const action = e.currentTarget.dataset.action;
      const type = e.currentTarget.dataset.type;

      if (action === '相手ミス') {
          recordOpponentMiss();
          return;
      }
      if (action === 'その他得点') {
          recordOtherPoint();
          return;
      }
      
      const modal = $('#modal');
      const title = $('#modalTitle');
      const actionInput = $('#modalAction');
      const typeInput = $('#modalType');
      const playerList = $('#player-select-list');
      const resultList = $('#result-select-list');
      
      title.textContent = `${action} 記録`;
      actionInput.value = action;
      typeInput.value = type;

      // プレイヤー選択リストの生成 (コート上のプレイヤーのみ)
      playerList.innerHTML = state.onCourtPlayerIds
          .map(id => getPlayerById(id))
          .filter(p => p)
          .map(p => {
              const isLibero = state.onCourtSize === 7 && state.onCourtPlayerIds.indexOf(p.id) === 6;
              const nameSuffix = isLibero ? ' (リベロ)' : '';
              return `
                <label class="choice-label">
                    <input type="radio" name="playerId" value="${p.id}" required />
                    <span>${escapeHtml(p.name.trim() || `ID${p.id}`)}${nameSuffix}</span>
                </label>
              `;
          }).join('');

      // 結果選択リストの生成
      const results = getActionResults(action);
      resultList.innerHTML = results.map(r => `
          <label class="choice-label">
              <input type="radio" name="result" value="${r.value}" 
                      data-is-point="${r.isPoint}" 
                      data-is-error="${r.isError}" required />
              <span>${escapeHtml(r.value)}</span>
          </label>
      `).join('');

      modal.classList.remove('hidden');
  }

  $('#modalConfirm').onclick = () => {
      const form = document.getElementById('actionForm');
      const selectedPlayer = form.querySelector('input[name="playerId"]:checked');
      const selectedResult = form.querySelector('input[name="result"]:checked');
      
      if (!selectedPlayer || !selectedResult) {
          alert('プレイヤーと結果を選択してください。');
          return;
      }

      const playerId = Number(selectedPlayer.value);
      const action = $('#modalAction').value;
      const result = selectedResult.value;
      const isPoint = selectedResult.dataset.isPoint === 'true';
      const isError = selectedResult.dataset.isError === 'true';

      recordAction(playerId, action, result, isPoint, isError);
      $('#modal').classList.add('hidden');
  };

  $('#modalCancel').onclick = () => { $('#modal').classList.add('hidden'); };


  function handleSubstitution(e) {
      const slotIndex = Number(e.currentTarget.dataset.slotIndex);
      const subOutPlayerId = state.onCourtPlayerIds[slotIndex];
      const subOutPlayer = getPlayerById(subOutPlayerId);
      
      if (!subOutPlayer) return;

      currentSubSlotIndex = slotIndex;
      
      let slotName = `スロット ${slotIndex + 1}`;
      if (state.onCourtSize === 7 && slotIndex === 6) slotName = 'リベロ枠';
      
      $('#subOutPlayerName').textContent = `${subOutPlayer.name.trim() || '---'} (${slotName}よりアウト)`;
      
      const subPlayerList = $('#sub-player-select-list');
      subPlayerList.innerHTML = '';

      // コート上にいない選手（交代要員）のみを表示
      const options = state.allPlayers
          .filter(p => !state.onCourtPlayerIds.includes(p.id)) 
          .map(p => `
              <label class="choice-label">
                  <input type="radio" name="subInPlayer" value="${p.id}" required />
                  <span>${escapeHtml(p.name.trim() || `ID${p.id}`)}</span>
              </label>
          `).join('');
      
      subPlayerList.innerHTML = options || '<p>交代可能な選手がいません。選手を登録してください。</p>';
      
      $('#subModal').classList.remove('hidden');
  }

  $('#subModalConfirm').onclick = () => {
      const selectedInPlayer = $('#sub-player-select-list input[name="subInPlayer"]:checked');
      
      if (!selectedInPlayer || currentSubSlotIndex === null) {
          alert('交代インする選手を選択してください。');
          return;
      }

      const newPlayerId = Number(selectedInPlayer.value);
      const oldPlayerId = state.onCourtPlayerIds[currentSubSlotIndex];

      // onCourtPlayerIdsを更新
      state.onCourtPlayerIds[currentSubSlotIndex] = newPlayerId;
      
      // ログ記録
      const newPlayer = getPlayerById(newPlayerId);
      state.log.push({ 
          time: Date.now(), 
          type: 'sub', 
          playerId: newPlayerId, 
          slotIndex: currentSubSlotIndex, 
          oldPlayerId: oldPlayerId,
          action: '交代',
          result: `スロット${currentSubSlotIndex + 1}に${newPlayer?.name}が入る`
      });

      currentSubSlotIndex = null;
      save();
      renderAll();
      $('#subModal').classList.add('hidden');
  };

  $('#subModalCancel').onclick = () => { 
      currentSubSlotIndex = null;
      $('#subModal').classList.add('hidden'); 
  };


  // --- レンダリング ---
  
  function renderPartial() {
      renderPlayers();
      renderLog();
  }

  function renderAll() {
    renderPlayers();
    renderLog();
    renderAllPlayersList(); 
  }

  function renderPlayers() {
    const container = $('#players');
    container.innerHTML = '';
    
    // コート上のスロットを描画 (state.onCourtSizeに基づく)
    for(let i=0; i < state.onCourtSize; i++) {
        const playerId = state.onCourtPlayerIds[i];
        const p = getPlayerById(playerId) || { id: 0, name: '未設定', totalPoints: 0, totalErrors: 0 }; 

        const totalScore = p.totalPoints - p.totalErrors;

        const div = document.createElement('div');
        div.className = 'player';
        div.setAttribute('data-slot-index', i);
        div.setAttribute('data-player-id', p.id);
        
        const displayName = p.name.trim() === '' ? '---' : p.name;
        const slotName = (state.onCourtSize === 7 && i === 6) ? ' (リベロ)' : ''; 

        div.innerHTML = `
          <h3 title="${displayName} (スロット ${i + 1})">${escapeHtml(displayName)}${slotName}</h3>
          <div class="player-info">
            <div>総評価: <span class="score" data-id="${p.id}">${totalScore}</span></div>
            <button class="sub-btn" data-slot-index="${i}">交代</button>
          </div>
          <div style="font-size:12px;opacity:0.8;">得点: ${p.totalPoints} / ミス: ${p.totalErrors}</div>
        `;
        container.appendChild(div);
    }

    $$('.sub-btn').forEach(b => {
      b.removeEventListener('click', handleSubstitution);
      b.addEventListener('click', handleSubstitution);
    });
  }
  
  // 選手登録リストの描画
  function renderAllPlayersList() {
      const container = $('#allPlayersList');
      const focusedElement = document.activeElement;
      const focusedId = focusedElement && focusedElement.classList.contains('edit-player-name') ? focusedElement.dataset.id : null;
      const focusedCursorPos = focusedElement ? focusedElement.selectionStart : null;
      
      container.innerHTML = '';
      
      state.allPlayers.forEach(p => {
          const div = document.createElement('div');
          div.className = 'player-register-row';
          const isOnCourt = state.onCourtPlayerIds.includes(p.id);
          
          let courtStatus = '';
          if (isOnCourt) {
              const slotIndex = state.onCourtPlayerIds.indexOf(p.id);
              courtStatus = (state.onCourtSize === 7 && slotIndex === 6) ? '【リベロ枠】' : '【コート上】';
          }
          
          const isRemovable = !state.onCourtPlayerIds.includes(p.id);

          div.innerHTML = `
            <input type="text" class="edit-player-name player-register-name-input" value="${escapeHtml(p.name)}" data-id="${p.id}" placeholder="名前を入力" inputmode="text" autocomplete="off" />
            <div style="width:140px; font-size:12px; align-self:center; color:${isOnCourt ? '#2a66b9' : '#888'};">
                ${courtStatus}
            </div>
            <button class="remove-player-btn" data-id="${p.id}" ${isRemovable ? '' : 'disabled'}>削除</button>
          `;
          container.appendChild(div);
      });
      

      $$('.edit-player-name').forEach(el => {
          el.removeEventListener('input', handlePlayerNameEdit); 
          el.addEventListener('input', handlePlayerNameEdit);
      });
      $$('.remove-player-btn').forEach(el => {
          el.onclick = handleRemovePlayer;
      });

      if (focusedId) {
          const newFocusedEl = $(`#allPlayersList input.edit-player-name[data-id="${focusedId}"]`);
          if (newFocusedEl) {
              newFocusedEl.focus();
              if (focusedCursorPos !== null) {
                  newFocusedEl.setSelectionRange(focusedCursorPos, focusedCursorPos);
              }
          }
      }
  }

  function handlePlayerNameEdit(e) {
      const id = Number(e.target.dataset.id);
      const newName = e.target.value;
      const player = getPlayerById(id);
      
      if (player) {
          player.name = newName; 
          save();
          renderPartial(); 
      }
  }


  function renderLog() {
    const ul = $('#log');
    ul.innerHTML = '';
    
    const activeTab = $('.log-tab-btn.active').dataset.tab;
    
    let currentTeamScore = 0;
    let currentOpponentScore = 0;

    for (const e of state.log) {
        const isAction = e.type === 'action' || e.type === 'point';
        const isOpponentMissButton = e.action === '相手ミス'; 
        const isOtherPointButton = e.action === 'その他得点';
        const scoreChange = isAction ? getScoreChanges(e.isPoint, e.isError, e.isOpponentPoint, isOpponentMissButton, isOtherPointButton) : { teamPointChange: 0, opponentPointChange: 0 };
        
        let logText = '';
        let shouldDisplay = true;

        if (e.type === 'sub') {
            const p = getPlayerById(e.playerId);
            const name = p ? p.name.trim() || '---' : '不明';
            
            let slotName = `スロット${e.slotIndex + 1}`;
            if (state.onCourtSize === 7 && e.slotIndex === 6) slotName = 'リベロ枠';

            logText = `【交代】${slotName} に ${name} がイン`;
            if (activeTab === 'point') shouldDisplay = false;
        } else {
            const player = getPlayerById(e.playerId);
            const name = player ? (player.name.trim() || '---') : '---';
            
            const hasScoreChange = scoreChange.teamPointChange > 0 || scoreChange.opponentPointChange > 0;
            
            logText = `${name} 【${e.action}】 ${e.result}`;
            
            if (isOpponentMissButton) {
                logText = `${state.opponentName} 【ミス】 ${state.teamName}が得点`;
            } else if (isOtherPointButton) {
                logText = `【その他得点】 ${state.teamName}が得点`;
            }

            if (hasScoreChange) {
                const scoreText = (currentTeamScore + scoreChange.teamPointChange) + '-' + (currentOpponentScore + scoreChange.opponentPointChange);
                logText += ` (${scoreText})`;
            } else if (activeTab === 'point') {
                shouldDisplay = false;
            }

            currentTeamScore += scoreChange.teamPointChange;
            currentOpponentScore += scoreChange.opponentPointChange;
        }

        if (shouldDisplay) {
            const li = document.createElement('li');
            li.textContent = logText;
            ul.prepend(li); 
        }
    }
  }

  // --- プレイヤー管理 ---
  function handleAddPlayer() {
      const input = $('#newPlayerName');
      const name = input.value.trim();
      if (!name) {
          alert('選手名を入力してください。');
          return;
      }
      if (state.allPlayers.some(p => p.name === name)) {
          alert('同じ名前の選手がすでにいます。');
          return;
      }

      const newPlayer = { id: nextPlayerId++, name: name, totalPoints: 0, totalErrors: 0 };
      state.allPlayers.push(newPlayer);
      input.value = '';
      save();
      renderAll(); 
  }

  function handleRemovePlayer(event) {
      const id = Number(event.currentTarget.dataset.id);
      if (state.onCourtPlayerIds.includes(id)) {
          alert('コート上の選手（最初の'+ state.onCourtSize + '枠）に割り当てられている選手は削除できません。');
          return;
      }
      if (!confirm(`選手 ${getPlayerById(id)?.name} を削除しますか？`)) return;

      state.allPlayers = state.allPlayers.filter(p => p.id !== id);
      save();
      renderAll();
  }

  // --- スコア・アクション記録 ---
  
  function recordOpponentMiss() {
      state.log.push({ 
          time: Date.now(), 
          type: 'point', 
          playerId: null, 
          action: '相手ミス', 
          result: state.teamName + 'が得点', 
          isPoint: true, 
          isError: false,
          isOpponentPoint: false
      });
      
      state.teamScore += 1; 
      
      save();
      renderPartial();
  }

  function recordOtherPoint() {
      state.log.push({ 
          time: Date.now(), 
          type: 'point', 
          playerId: null, 
          action: 'その他得点', 
          result: state.teamName + 'が得点', 
          isPoint: true, 
          isError: false,
          isOpponentPoint: false
      });
      
      state.teamScore += 1;
      
      save();
      renderPartial();
  }


  function recordAction(playerId, action, result, isPoint, isError) {
      const isOpponentPoint = isError; 
      const scoreChange = getScoreChanges(isPoint, isError, isOpponentPoint, false, false);
      
      const ev = { 
          time: Date.now(), 
          type: 'action', 
          playerId: playerId, 
          action: action, 
          result: result, 
          isPoint: isPoint, 
          isError: isError,
          isOpponentPoint: isOpponentPoint
      };
      
      state.log.push(ev);

      state.teamScore += scoreChange.teamPointChange;
      state.opponentScore += scoreChange.opponentPointChange;
      
      if (playerId) {
          const p = getPlayerById(playerId);
          if (p) {
              if (isPoint) p.totalPoints += 1;
              if (isError) p.totalErrors += 1;
          }
      }
      
      save();
      renderPartial();
  }


  function recomputeFromLog() {
    state.allPlayers.forEach(p => { p.totalPoints = 0; p.totalErrors = 0; });
    state.teamScore = 0;
    state.opponentScore = 0;

    for (const e of state.log) {
      const isOpponentMissButton = e.action === '相手ミス';
      const isOtherPointButton = e.action === 'その他得点';
      const scoreChange = getScoreChanges(e.isPoint, e.isError, e.isOpponentPoint, isOpponentMissButton, isOtherPointButton);

      if (e.type === 'action') {
        if (e.playerId) { 
            const p = getPlayerById(e.playerId);
            if (p) {
                if (e.isPoint) p.totalPoints += 1;
                if (e.isError) p.totalErrors += 1;
            }
        }
      } 
      
      state.teamScore += scoreChange.teamPointChange;
      state.opponentScore += scoreChange.opponentPointChange;
    }
  }

  // --- エクスポート ---
  function tallyActionsByPlayer() {
      const actionDetails = [];
      const allActionResults = {};

      for (const typeKey in ACTION_CONFIG) {
          const config = ACTION_CONFIG[typeKey];
          config.actions.forEach(actionName => {
              actionDetails.push(actionName);
              config.results.forEach(res => {
                  if (!allActionResults[actionName]) allActionResults[actionName] = new Set();
                  allActionResults[actionName].add(res.value);
              });
          });
      }
      
      actionDetails.push('相手ミス');
      allActionResults['相手ミス'] = new Set([state.teamName + 'が得点']);

      const tally = new Map(); 

      // すべてのプレイヤーを集計対象とする
      state.allPlayers.forEach(p => {
          tally.set(p.id, { 
              id: p.id,
              name: p.name.trim() || `ID${p.id}`,
              actions: actionDetails.reduce((acc, action) => {
                  acc[action] = {};
                  Array.from(allActionResults[action] || []).forEach(result => {
                      acc[action][result] = 0;
                  });
                  return acc;
              }, {})
          });
      });

      // ログから集計（交代した人の記録もplayerIdで集計）
      state.log.forEach(e => {
          if (e.type === 'action' && e.playerId) {
              const action = e.action;
              const result = e.result;
              const playerTally = tally.get(e.playerId);

              if (playerTally && playerTally.actions[action] && playerTally.actions[action][result] !== undefined) {
                  playerTally.actions[action][result] += 1;
              }
          } 
      });
      
      return { 
          tallyData: Array.from(tally.values()), 
          actionResultsMap: allActionResults,
          actionCategories: actionDetails.filter(a => a !== '相手ミス')
      };
  }

  function buildExportTable() {
      const table = $('#exportTable');
      const { tallyData, actionResultsMap, actionCategories } = tallyActionsByPlayer();
      
      if (tallyData.length === 0 && state.log.filter(e => e.type === 'action' || e.action === '相手ミス').length === 0) {
          table.innerHTML = `<caption>選手別アクション集計</caption><tr><td>ログにアクション記録がありません。</td></tr>`;
          return;
      }

      let html = '<thead><tr><th rowspan="2">選手名</th>';
      let subHeader = '<tr>';

      actionCategories.forEach(action => {
          const results = Array.from(actionResultsMap[action] || []).filter(r => r !== state.teamName + 'が得点');
          if (results.length > 0) {
              html += `<th colspan="${results.length}">${action}</th>`;
              results.forEach(result => {
                  subHeader += `<th>${result}</th>`;
              });
          }
      });
      
      html += `</tr>${subHeader}</tr></thead>`;

      html += '<tbody>';
      const activePlayerIds = new Set(state.log.filter(e => e.playerId).map(e => e.playerId).concat(state.onCourtPlayerIds));
      
      tallyData.forEach(pData => {
          if (!activePlayerIds.has(pData.id)) {
              return; 
          }

          let row = `<tr><td>${escapeHtml(pData.name)}</td>`;
          
          actionCategories.forEach(action => {
              const results = Array.from(actionResultsMap[action] || []).filter(r => r !== state.teamName + 'が得点');
              results.forEach(result => {
                  const count = pData.actions[action] ? (pData.actions[action][result] || 0) : 0;
                  row += `<td>${count || ''}</td>`;
              });
          });
          
          row += '</tr>';
          html += row;
      });
      
      html += '</tbody>';
      table.innerHTML = html;
  }
  
  function updateExportInfo() {
      const dateString = getFormattedDate(state.matchDate);
      const score = `${state.teamScore} - ${state.opponentScore}`;

      const infoHtml = `
          <p>日付: ${dateString}</p>
          <p>対戦相手: ${escapeHtml(state.opponentName || '（未設定）')}</p>
          <p>セット数: ${state.currentSet}セット目</p>
          <p>最終スコア: ${score} (自チーム - 相手チーム)</p>
      `;
      $('#exportInfo').innerHTML = infoHtml;
  }

  function showExportScreen() {
      updateExportInfo();
      buildExportTable();
      $('#exportModal').classList.remove('hidden');
  }

  // --- 初期化 ---
  function initUI() {
    load();
    
    // リベロ有無の初期設定とイベントハンドラ
    const liberoSelect = $('#liberoStatus');
    liberoSelect.value = String(state.onCourtSize);
    liberoSelect.onchange = (e) => {
        const newSize = Number(e.target.value);
        if (newSize !== state.onCourtSize) {
            if (state.log.length > 0) {
                if (!confirm('コートサイズを変更すると、現在のコート上の配置がリセットされますがよろしいですか？（ログ・スコアは保持されます）')) {
                    e.target.value = String(state.onCourtSize); 
                    return;
                }
            }
            initPlayers(newSize, true); 
            save();
            renderAll();
        }
    };

    $('#newGame').onclick = () => {
      if (!confirm('新しい試合を開始します。スコア、ログ、試合情報がリセットされます。よろしいですか？')) return;
      initPlayers(state.onCourtSize); 
      save();
      renderAll();
    };
    $('#showExportScreen').onclick = showExportScreen;
    $('#exportModalClose').onclick = () => { $('#exportModal').classList.add('hidden'); };

    // 試合情報コントロール
    $('#opponentName').value = state.opponentName || '相手';
    $('#opponentName').oninput = (e) => { state.opponentName = e.target.value; save(); };
    $('#currentSet').value = state.currentSet || 1;
    $('#currentSet').onchange = (e) => { 
        let val = parseInt(e.target.value);
        if (isNaN(val) || val < 1) val = 1;
        state.currentSet = val; 
        e.target.value = val;
        save(); 
    };
    
    $('#addPlayer').onclick = handleAddPlayer;

    $('#undo').onclick = () => {
      if (state.log.length === 0) return;
      state.log.pop();
      recomputeFromLog(); 
      save();
      renderAll();
    };

    $('#clearLog').onclick = () => {
      if (!confirm('ログを消しますか？スコアとアクション記録がリセットされます。')) return;
      initPlayers(state.onCourtSize, true); 
      state.log = [];
      state.teamScore = 0;
      state.opponentScore = 0;
      save();
      renderAll();
    };

    $$('.action').forEach(b => {
      b.onclick = handleActionButton;
    });

    $$('.log-tab-btn').forEach(btn => {
        btn.onclick = (e) => {
            $$('.log-tab-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            renderLog();
        };
    });

    renderAll();
  }

  // 起動
  document.addEventListener('DOMContentLoaded', initUI);
})();
</script>
</body>
</html>
